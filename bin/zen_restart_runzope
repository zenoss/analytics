#!/usr/bin/env bash
#
# zen_restart_runzope - shell script restarting runzope when zope leaks mem.
#
##############################################################################
#
# Copyright (C) Zenoss, Inc. 2017, all rights reserved.
#
# This content is made available according to terms specified in
# License.zenoss under the directory where your Zenoss product is installed.
#
##############################################################################

# set the default max to 2G if not given
(( ZOPE_MAX_MEM=${ZOPE_MAX_MEM:-2097152} ))
(( ZOPE_MAX_MEM==0 )) && (( ZOPE_MAX_MEM=2097152 ))

# 10 minutes
poll_t=600

# runzope pid
pid_f=/opt/zenoss/var/Z2.pid

while sleep $poll_t
do
   if [[ -f $pid_f ]]
   then
       pid=$(cat $pid_f)
       (( vsz = $(ps -ho vsz $pid) ))

       # if vsz is too big, restart zope
       (( vsz > ZOPE_MAX_MEM )) && kill -HUP $pid
   fi
done
